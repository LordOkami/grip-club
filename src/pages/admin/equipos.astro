---
import AdminLayout from '../../layouts/AdminLayout.astro';
---

<AdminLayout title="Equipos" currentSection="equipos">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-bold text-white" style="font-family: 'Bebas Neue', sans-serif;">
          Equipos Registrados
        </h1>
        <p class="text-racing-silver mt-1" id="teams-count">Cargando...</p>
      </div>

      <!-- Filters -->
      <div class="flex flex-wrap gap-2">
        <select id="filter-status" class="bg-racing-gray border border-racing-silver/20 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:border-red-600">
          <option value="">Todos los estados</option>
          <option value="draft">Borrador</option>
          <option value="pending">Pendiente</option>
          <option value="confirmed">Confirmado</option>
          <option value="cancelled">Cancelado</option>
        </select>

        <select id="filter-photo" class="bg-racing-gray border border-racing-silver/20 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:border-red-600">
          <option value="">Todas las fotos</option>
          <option value="pending">Fotos pendientes</option>
          <option value="approved">Fotos aprobadas</option>
          <option value="rejected">Fotos rechazadas</option>
          <option value="none">Sin foto</option>
        </select>

        <input type="text" id="filter-search" placeholder="Buscar equipo..."
               class="bg-racing-gray border border-racing-silver/20 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:border-red-600 w-48">
      </div>
    </div>

    <!-- Pending Photo Reviews Alert -->
    <div id="photo-review-alert" class="hidden mb-6 bg-yellow-600/20 border border-yellow-500/30 rounded-xl p-4 flex items-center gap-4">
      <div class="w-10 h-10 bg-yellow-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
        <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
      </div>
      <div>
        <p class="text-yellow-400 font-medium"><span id="pending-photo-count">0</span> fotos pendientes de revision</p>
        <p class="text-yellow-500/70 text-sm">Haz clic en un equipo para revisar y aprobar/rechazar su foto de moto</p>
      </div>
    </div>

    <!-- Teams Table -->
    <div class="bg-racing-gray rounded-xl border border-racing-silver/10 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-racing-black/50">
            <tr>
              <th class="text-left px-6 py-4 text-racing-silver text-sm font-medium">Equipo</th>
              <th class="text-left px-6 py-4 text-racing-silver text-sm font-medium">Representante</th>
              <th class="text-left px-6 py-4 text-racing-silver text-sm font-medium">Pilotos</th>
              <th class="text-left px-6 py-4 text-racing-silver text-sm font-medium">Foto</th>
              <th class="text-left px-6 py-4 text-racing-silver text-sm font-medium">Estado</th>
              <th class="text-left px-6 py-4 text-racing-silver text-sm font-medium">Fecha</th>
              <th class="text-left px-6 py-4 text-racing-silver text-sm font-medium">Acciones</th>
            </tr>
          </thead>
          <tbody id="teams-table" class="divide-y divide-racing-silver/10">
            <tr>
              <td colspan="7" class="px-6 py-8 text-center text-racing-silver">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-600 mx-auto mb-2"></div>
                Cargando equipos...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Status Change Modal -->
  <div id="status-modal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
    <div class="bg-racing-gray rounded-xl max-w-md w-full p-6">
      <h3 class="text-xl font-semibold text-white mb-4">Cambiar Estado</h3>
      <p class="text-racing-silver mb-4">Equipo: <span id="modal-team-name" class="text-white"></span></p>

      <select id="modal-status" class="w-full bg-racing-black border border-racing-silver/20 rounded-lg px-4 py-3 text-white mb-4 focus:outline-none focus:border-red-600">
        <option value="draft">Borrador</option>
        <option value="pending">Pendiente</option>
        <option value="confirmed">Confirmado</option>
        <option value="cancelled">Cancelado</option>
      </select>

      <div class="flex gap-3">
        <button id="modal-cancel" class="flex-1 px-4 py-2 bg-racing-silver/20 text-white rounded-lg hover:bg-racing-silver/30 transition-colors">
          Cancelar
        </button>
        <button id="modal-confirm" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
          Guardar
        </button>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  import { firebaseAuth } from '../../lib/firebase-auth';

  let allTeams: any[] = [];
  let currentTeamId: string | null = null;

  const statusColors: Record<string, string> = {
    draft: 'bg-gray-500',
    pending: 'bg-yellow-500',
    confirmed: 'bg-green-500',
    cancelled: 'bg-red-500'
  };

  const statusLabels: Record<string, string> = {
    draft: 'Borrador',
    pending: 'Pendiente',
    confirmed: 'Confirmado',
    cancelled: 'Cancelado'
  };

  const photoStatusColors: Record<string, string> = {
    pending: 'bg-yellow-500',
    approved: 'bg-green-500',
    rejected: 'bg-red-500'
  };

  const photoStatusLabels: Record<string, string> = {
    pending: 'Pendiente',
    approved: 'Aprobada',
    rejected: 'Rechazada'
  };

  async function loadTeams() {
    try {
      await firebaseAuth.waitForInit();
      const token = await firebaseAuth.getToken();
      const response = await fetch('/api/admin-teams', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!response.ok) throw new Error('Error loading teams');

      const { teams, stats } = await response.json();
      allTeams = teams;

      document.getElementById('teams-count')!.textContent = `${stats.total} equipos registrados`;

      // Show pending photo reviews alert
      if (stats.pendingPhotoReviews > 0) {
        document.getElementById('photo-review-alert')!.classList.remove('hidden');
        document.getElementById('pending-photo-count')!.textContent = stats.pendingPhotoReviews.toString();
      }

      renderTeams(teams);
    } catch (error) {
      console.error('Error:', error);
      document.getElementById('teams-table')!.innerHTML = `
        <tr>
          <td colspan="7" class="px-6 py-8 text-center text-red-500">
            Error al cargar los equipos
          </td>
        </tr>
      `;
    }
  }

  function renderTeams(teams: any[]) {
    const tbody = document.getElementById('teams-table')!;

    if (teams.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="px-6 py-8 text-center text-racing-silver">
            No se encontraron equipos
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = teams.map(team => {
      let dateStr = '-';
      if (team.createdAt) {
        const dateVal = team.createdAt.toDate ? team.createdAt.toDate() : new Date(team.createdAt);
        dateStr = dateVal.toLocaleDateString('es-ES');
      }

      // Photo status indicator
      let photoIndicator = `<span class="text-racing-silver text-xs">Sin foto</span>`;
      if (team.motorcyclePhoto) {
        const photoStatus = team.motorcyclePhotoStatus || 'pending';
        photoIndicator = `
          <span class="px-2 py-1 rounded text-xs text-white ${photoStatusColors[photoStatus] || 'bg-gray-500'}">
            ${photoStatusLabels[photoStatus] || photoStatus}
          </span>
        `;
      }

      return `
        <tr class="hover:bg-racing-silver/5 transition-colors">
          <td class="px-6 py-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-red-600/20 rounded-lg flex items-center justify-center">
                <span class="text-red-500 font-bold">${team.name?.charAt(0) || '?'}</span>
              </div>
              <div>
                <div class="text-white font-medium">${team.name || 'Sin nombre'}${team.preferredNumber ? ` <span class="text-racing-silver text-xs">#${team.preferredNumber}</span>` : ''}</div>
                <div class="text-racing-silver text-xs">${team.representativeEmail || ''}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 text-racing-silver">
            ${team.representativeName || ''} ${team.representativeSurname || ''}
          </td>
          <td class="px-6 py-4">
            <span class="text-white">${team.pilotsCount}</span>
            <span class="text-racing-silver">/ ${team.numberOfPilots || 4}</span>
          </td>
          <td class="px-6 py-4">
            ${photoIndicator}
          </td>
          <td class="px-6 py-4">
            <span class="px-2 py-1 rounded text-xs text-white ${statusColors[team.status] || 'bg-gray-500'}">
              ${statusLabels[team.status] || team.status}
            </span>
          </td>
          <td class="px-6 py-4 text-racing-silver text-sm">${dateStr}</td>
          <td class="px-6 py-4">
            <div class="flex items-center gap-2">
              <a href="/admin/equipos/${team.id}" class="p-2 text-racing-silver hover:text-white transition-colors" title="Ver detalle">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
              </a>
              <button onclick="openStatusModal('${team.id}', '${team.name}', '${team.status}')" class="p-2 text-racing-silver hover:text-white transition-colors" title="Cambiar estado">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  function filterTeams() {
    const status = (document.getElementById('filter-status') as HTMLSelectElement).value;
    const photoStatus = (document.getElementById('filter-photo') as HTMLSelectElement).value;
    const search = (document.getElementById('filter-search') as HTMLInputElement).value.toLowerCase();

    let filtered = allTeams;

    if (status) {
      filtered = filtered.filter(t => t.status === status);
    }

    if (photoStatus) {
      if (photoStatus === 'none') {
        filtered = filtered.filter(t => !t.motorcyclePhoto);
      } else {
        filtered = filtered.filter(t => t.motorcyclePhoto && t.motorcyclePhotoStatus === photoStatus);
      }
    }

    if (search) {
      filtered = filtered.filter(t =>
        t.name?.toLowerCase().includes(search) ||
        t.representativeName?.toLowerCase().includes(search) ||
        t.representativeSurname?.toLowerCase().includes(search) ||
        t.representativeEmail?.toLowerCase().includes(search)
      );
    }

    renderTeams(filtered);
  }

  // Make openStatusModal global
  (window as any).openStatusModal = function(teamId: string, teamName: string, currentStatus: string) {
    currentTeamId = teamId;
    document.getElementById('modal-team-name')!.textContent = teamName;
    (document.getElementById('modal-status') as HTMLSelectElement).value = currentStatus;
    document.getElementById('status-modal')!.classList.remove('hidden');
  };

  async function updateStatus() {
    if (!currentTeamId) return;

    const newStatus = (document.getElementById('modal-status') as HTMLSelectElement).value;

    try {
      await firebaseAuth.waitForInit();
      const token = await firebaseAuth.getToken();
      const response = await fetch(`/api/admin-teams?id=${currentTeamId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ status: newStatus })
      });

      if (!response.ok) throw new Error('Error updating status');

      // Close modal and reload
      document.getElementById('status-modal')!.classList.add('hidden');
      currentTeamId = null;
      loadTeams();

    } catch (error) {
      console.error('Error:', error);
      alert('Error al actualizar el estado');
    }
  }

  // Event listeners
  document.getElementById('filter-status')?.addEventListener('change', filterTeams);
  document.getElementById('filter-photo')?.addEventListener('change', filterTeams);
  document.getElementById('filter-search')?.addEventListener('input', filterTeams);
  document.getElementById('modal-cancel')?.addEventListener('click', () => {
    document.getElementById('status-modal')!.classList.add('hidden');
    currentTeamId = null;
  });
  document.getElementById('modal-confirm')?.addEventListener('click', updateStatus);

  // Close modal on backdrop click
  document.getElementById('status-modal')?.addEventListener('click', (e) => {
    if (e.target === e.currentTarget) {
      document.getElementById('status-modal')!.classList.add('hidden');
      currentTeamId = null;
    }
  });

  // Load teams
  loadTeams();
</script>
